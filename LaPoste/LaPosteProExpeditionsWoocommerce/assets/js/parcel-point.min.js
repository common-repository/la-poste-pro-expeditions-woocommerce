"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){var e={};e.api={ajaxUrl:null,getShippingMethodExtraLabelNonce:null,getPointsNonce:null,setPointNonce:null,setApiConfiguration:function(e,t,o,n){this.ajaxUrl=e,this.getShippingMethodExtraLabelNonce=t,this.getPointsNonce=o,this.setPointNonce=n},selectPoint:function(e,t,o,n,a,i,r,p,c,s,l,d,u){var h=this,m=new XMLHttpRequest;m.onreadystatechange=function(){if(4===m.readyState){var e=h.getRequestResponse(m);h.isValidResponse(e)?d({data:e.data,name:n,address:i,zipcode:r,city:p,distance:l}):u(e)}},m.open("POST",h.ajaxUrl),m.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),m.responseType="json",m.send("action=laposteproexp_set_point&carrier="+encodeURIComponent(e)+"&code="+encodeURIComponent(o)+"&name="+encodeURIComponent(n)+"&address="+encodeURIComponent(i)+"&zipcode="+encodeURIComponent(r)+"&city="+encodeURIComponent(p)+"&country="+encodeURIComponent(c)+"&openingHours="+encodeURIComponent(s)+"&network="+encodeURIComponent(a)+"&packageKey="+encodeURIComponent(t)+"&_wpnonce="+encodeURIComponent(h.setPointNonce))},getParcelPoints:function(e,t,o,n){var a=this,i=new XMLHttpRequest;i.onreadystatechange=function(){if(4===i.readyState){var e=a.getRequestResponse(i);a.isValidResponse(e)?o(e.data):n(e)}},i.open("POST",a.ajaxUrl),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.responseType="json",i.send("action=laposteproexp_get_points&carrier="+encodeURIComponent(e)+"&packageKey="+encodeURIComponent(t)+"&_wpnonce="+encodeURIComponent(a.getPointsNonce))},getShippingMethodExtraLabel:function(e,t,o,n){var a=this,i=new XMLHttpRequest;i.onreadystatechange=function(){if(4===i.readyState){var e=a.getRequestResponse(i);a.isValidResponse(e)?o(e.data):n(e)}},i.open("POST",a.ajaxUrl),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.responseType="json",i.send("action=laposteproexp_get_shipping_method_extra_label&shippingMethod="+encodeURIComponent(e)+"&packageKey="+encodeURIComponent(t)+"&_wpnonce="+encodeURIComponent(a.getShippingMethodExtraLabelNonce))},isValidResponse:function(e){return"object"===(void 0===e?"undefined":_typeof(e))&&null!==e&&!0===e.success&&"data"in e},getRequestResponse:function(e){return"object"===_typeof(e.response)&&null!==e.response?e.response:JSON.parse(e.response)}},e.util={on:function(e,t,o,n){if("undefined"!=typeof jQuery)jQuery(e).on(t,o,n);else{var a=document.querySelector(e);a.addEventListener(t,function(e){for(var t=a.querySelectorAll(o),i=e.target,r=0,p=t.length;r<p;r++)for(var c=i,s=t[r];c&&c!==a;){if(c===s)return n.call(s,e);c=c.parentNode}})}},observeDom:function(e,t,o){var n=void 0;return(n=new MutationObserver(function(e){var n=!0,a=!1,i=undefined;try{for(var r,p=e[Symbol.iterator]();!(n=(r=p.next()).done);n=!0){var c=r.value;if(t(c)){setTimeout(function(){return o()});break}}}catch(s){a=!0,i=s}finally{try{!n&&p["return"]&&p["return"]()}finally{if(a)throw i}}})).observe(e,{childList:!0,subtree:!0,attributes:!0,characterData:!1}),n},formatDistance:function(t){var o="undefined"!=typeof wp&&"i18n"in wp?wp.i18n.__("%skm away","la-poste-pro-expeditions-woocommerce"):e.util.translate("%skm away"),n=null;return null!==t&&(t=Math.round(t/100)/10,isNaN(t)||(n=" ("+this.sprintf(o,t)+")")),n},formatParcelPoingAddress:function(t,o,n,a){var i=[t,[n,o].filter(function(e){return null!==e}).join(", ")].join(" ");return null!==(a=e.util.formatDistance(a))&&(i+=" "+a),i},fillSpaces:function(e,t){for(;e.length<t;)e+=" ";return e},formatOpeningDays:function(t){for(var o=[],n=e.util.fillSpaces("",11),a=0;a<t.length;a++){var i=t[a];if(i.weekday){for(var r=i.weekday[0]+" ",p=i.openingPeriods,c=[],s=0;s<p.length;s++){var l=p[s],d=l.openingTime===undefined?"":l.openingTime,u=l.closingTime===undefined?"":l.closingTime;""!==d&&""!==u?c.push(d+"-"+u):c.push(n)}r+=c.join(" "),a%2==1&&(r='<span style="background-color: #d8d8d8;">'+r+"</span>"),o.push(r)}}return'<pre class="laposteproexp-parcel-point-schedule">'+o.join("\n")+"</pre>"},formatHours:function(e){var t=e.split(":");return 3===t.length&&(e=t[0]+":"+t[1]),e},isWoocommerceBlocks:function(){return"wc"in window&&"blocksCheckout"in window.wc&&"wcSettings"in window.wc&&window.wc.wcSettings.getSetting("la-poste-pro-expeditions-woocommerce-parcel-point_data")},isI18nEnabled:function(){return"undefined"!=typeof wp&&"i18n"in wp},translate:function(e){var t=e;return"undefined"!=typeof translations&&e in translations&&(t=translations[e]),t},sprintf:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){for(var t=arguments.length,o=Array(t>1?t-1:0),n=1;n<t;n++)o[n-1]=arguments[n];if("undefined"!=typeof sprintf)return sprintf.apply(undefined,[e].concat(o));var a=!0,i=!1,r=undefined;try{for(var p,c=o[Symbol.iterator]();!(a=(p=c.next()).done);a=!0){var s=p.value;e=e.replace("%s",s)}}catch(l){i=!0,r=l}finally{try{!a&&c["return"]&&c["return"]()}finally{if(i)throw r}}return e})},e.map={mapContainer:null,map:null,markers:[],mapUrl:null,mapLogoImageUrl:null,mapLogoHrefUrl:null,setMapConfiguration:function(e,t,o){this.mapUrl=e,this.mapLogoImageUrl=t,this.mapLogoHrefUrl=o},init:function(){var t=this,o=document.createElement("div");if(t.mapContainer=document.querySelector("#laposteproexp-map"),!t.mapContainer){var n=e.util.isI18nEnabled()?wp.i18n.__("Close map","la-poste-pro-expeditions-woocommerce"):e.util.translate("Close map");o.setAttribute("class","laposteproexp-close"),o.setAttribute("title",n),o.addEventListener("click",function(){t.close()});var a=document.createElement("div");a.setAttribute("id","laposteproexp-map-canvas");var i=document.createElement("div");i.setAttribute("id","laposteproexp-map-container"),i.appendChild(a);var r=document.createElement("div");r.setAttribute("id","laposteproexp-pp-container");var p=document.createElement("div");p.setAttribute("id","laposteproexp-map-inner"),p.appendChild(o),p.appendChild(i),p.appendChild(r),t.mapContainer=document.createElement("div"),t.mapContainer.setAttribute("id","laposteproexp-map"),t.mapContainer.appendChild(p),document.body.appendChild(t.mapContainer),t.map=new mapboxgl.Map({container:"laposteproexp-map-canvas",style:t.mapUrl,zoom:14,accessToken:"whatever"}),t.map.addControl(new mapboxgl.NavigationControl);var c=document.createElement("img");c.setAttribute("src",t.mapLogoImageUrl);var s=document.createElement("a");s.setAttribute("href",t.mapLogoHrefUrl),s.setAttribute("target","_blank"),s.appendChild(c);var l=document.createElement("div");l.setAttribute("id","laposteproexp-logo"),l.appendChild(s);var d=document.querySelector(".mapboxgl-ctrl-top-left");d&&d.appendChild(l)}},open:function(){this.mapContainer.classList.add("laposteproexp-modal-show");var e=window.pageYOffset+(window.innerHeight-this.mapContainer.offsetHeight)/2;e<window.pageYOffset&&(e=window.pageYOffset),this.mapContainer.style.top=e+"px",this.map.resize()},close:function(){this.mapContainer.classList.remove("laposteproexp-modal-show"),this.clearMarkers()},addParcelPointMarkers:function(e){for(var t=0;t<e.length;t++)e[t].index=t,this.addParcelPointMarker(e[t])},addParcelPointMarker:function(t){var o=e.util.isI18nEnabled()?wp.i18n.__("Choose this parcel point","la-poste-pro-expeditions-woocommerce"):e.util.translate("Choose this parcel point"),n=e.util.isI18nEnabled()?wp.i18n.__("Opening hours","la-poste-pro-expeditions-woocommerce"):e.util.translate("Opening hours"),a='<div class="laposteproexp-marker-popup"><b>'+t.parcelPoint.name+'</b><br/><a href="#" class="laposteproexp-parcel-point-button" '+this.generateParcelPointTagData(t)+"><b>"+o+"</b></a><br/>"+t.parcelPoint.location.street+", "+t.parcelPoint.location.zipCode+" "+t.parcelPoint.location.city+"<br/><b>"+n+"</b><br/>";a+=e.util.formatOpeningDays(t.parcelPoint.openingDays);var i=this.getMarkerHtmlElement(t.index+1),r=new mapboxgl.Popup({offset:25}).setHTML(a),p=new mapboxgl.Marker({element:i,anchor:"bottom"}).setLngLat(new mapboxgl.LngLat(parseFloat(t.parcelPoint.location.position.longitude),parseFloat(t.parcelPoint.location.position.latitude))).setPopup(r).addTo(this.map);this.markers.push(p),this.addRightColMarkerEvent(p,t.parcelPoint.code)},generateParcelPointTagData:function(e){return' data-code="'+e.parcelPoint.code+'" data-name="'+encodeURIComponent(e.parcelPoint.name)+'" data-network="'+e.parcelPoint.network+'" data-zipcode="'+encodeURIComponent(e.parcelPoint.location.zipCode)+'" data-country="'+encodeURIComponent(e.parcelPoint.location.country)+'" data-city="'+encodeURIComponent(e.parcelPoint.location.city)+'" data-street="'+encodeURIComponent(e.parcelPoint.location.street)+'" data-openinghours="'+encodeURIComponent(JSON.stringify(e.parcelPoint.openingDays))+'" data-distance="'+encodeURIComponent(JSON.stringify(e.distanceFromSearchLocation))+'" '},addRightColMarkerEvent:function(t,o){e.util.on("body","click",".laposteproexp-show-info-"+o,function(){t.togglePopup()})},addRecipientMarker:function(e){var t=document.createElement("div");t.className="laposteproexp-marker-recipient";var o=new mapboxgl.Marker({element:t,anchor:"bottom"}).setLngLat(new mapboxgl.LngLat(parseFloat(e.position.longitude),parseFloat(e.position.latitude))).addTo(this.map);this.markers.push(o)},setMapBounds:function(){for(var e=new mapboxgl.LngLatBounds,t=0;t<this.markers.length;t++){var o=this.markers[t];e=e.extend(o.getLngLat())}this.map.fitBounds(e,{padding:30,linear:!0})},fillParcelPointPanel:function(t){var o=e.util.isI18nEnabled()?wp.i18n.__("Choose this parcel point","la-poste-pro-expeditions-woocommerce"):e.util.translate("Choose this parcel point"),n="";n+="<table><tbody>";for(var a=0;a<t.length;a++){var i=t[a],r=e.util.formatDistance(i.distanceFromSearchLocation);n+="<tr>",n+="<td>"+this.getMarkerHtmlElement(a+1).outerHTML,n+='<div class="laposteproexp-parcel-point-title"><a class="laposteproexp-show-info-'+i.parcelPoint.code+'">'+i.parcelPoint.name+"</a></div><br/>",n+=i.parcelPoint.location.street+"<br/>",n+=i.parcelPoint.location.zipCode+" "+i.parcelPoint.location.city+(null!==r?r:"")+"<br/>",n+='<a class="laposteproexp-parcel-point-button" '+this.generateParcelPointTagData(i)+"><b>"+o+"</b></a>",n+="</td>",n+="</tr>"}n+="</tbody></table>",document.querySelector("#laposteproexp-pp-container").innerHTML=n},getMarkerHtmlElement:function(e){var t=document.createElement("div");return t.className="laposteproexp-marker",t.innerHTML=e,t},clearMarkers:function(){for(var e=0;e<this.markers.length;e++)this.markers[e].remove();this.markers=[]},getPoints:function(t,o,n){var a=this;e.api.getParcelPoints(t,o,function(e){a.addParcelPointMarkers(e.nearbyParcelPoints),a.fillParcelPointPanel(e.nearbyParcelPoints),a.addRecipientMarker(e.searchLocation),a.setMapBounds()},function(e){"object"===(void 0===e?"undefined":_typeof(e))&&"data"in e&&a.showError(e.data.message)})}},e.blocks={cache:{},loading:!1,init:function(){var t=this,o=(0,window.wc.wcSettings.getSetting)("la-poste-pro-expeditions-woocommerce-parcel-point_data");if(o){e.api.setApiConfiguration(o.ajaxurl,o.getShippingMethodExtraLabelNonce,o.getPointsNonce,o.setPointNonce),e.map.setMapConfiguration(o.mapUrl,o.mapLogoImageUrl,o.mapLogoHrefUrl);var n=!1;t.onCartChange(function(){t.updateSelectedShippingMethodExtraLabel(),n||(n=!0,jQuery("body").on("input",t.getShippintMethodInputsSelector(),function(){return t.updateSelectedShippingMethodExtraLabel()}))}),jQuery("body").on("click",".laposteproexp-select-parcel",function(){e.map.init(),e.map.open(),t.getMapPoints()}),jQuery("body").on("click",".laposteproexp-parcel-point-button",function(){var o=wp.i18n.__,n=t.getSelectedShippingMethod(),a=t.getSelectedPackageKey();n||t.showError(o("Unable to find carrier","la-poste-pro-expeditions-woocommerce")),e.api.selectPoint(n,a,this.getAttribute("data-code"),decodeURIComponent(this.getAttribute("data-name")),this.getAttribute("data-network"),decodeURIComponent(this.getAttribute("data-street")),decodeURIComponent(this.getAttribute("data-zipcode")),decodeURIComponent(this.getAttribute("data-city")),decodeURIComponent(this.getAttribute("data-country")),decodeURIComponent(this.getAttribute("data-openinghours")),decodeURIComponent(this.getAttribute("data-distance")),function(o){var i=o.data;t.updateShippingMethodExtraLabelCache(a,n,i.label),t.refreshShippingMethodExtraLabel(),e.map.close()},function(e){"object"===(void 0===e?"undefined":_typeof(e))&&"data"in e&&t.showError(e.data.message)})})}else console.error("[la-poste-pro-expeditions-woocommerce] Failed to load plugin configuration (blocks)")},getMapPoints:function(){var t=wp.i18n.__,o=this,n=o.getSelectedShippingMethod(),a=o.getSelectedPackageKey();n&&null!==a||o.showError(t("Unable to find carrier","la-poste-pro-expeditions-woocommerce")),e.map.getPoints(n,a,function(e){return o.showError(e)})},updateSelectedShippingMethodExtraLabel:function(){var t=wp.i18n.__,o=this;o.refreshShippingMethodExtraLabel();var n=o.getSelectedShippingMethod(),a=o.getSelectedPackageKey();n===undefined||a===undefined||o.loading||(o.loading=!0,e.api.getShippingMethodExtraLabel(n,a,function(e){o.updateShippingMethodExtraLabelCache(a,n,e.label),o.refreshShippingMethodExtraLabel(),o.loading=!1},function(){o.showError(t("Unable to find carrier","la-poste-pro-expeditions-woocommerce")),o.loading=!1}))},getSelectedShippingMethod:function(){return jQuery(this.getShippintMethodInputsSelector()).filter(":checked").val()},getSelectedPackageKey:function(){var e=0,t=jQuery(this.getShippintMethodInputsSelector()).filter(":checked").attr("name");if(t){var o=t.split("-");e=o[o.length-1]}return e},getShippintMethodInputsSelector:function(){var e=this;return e.getShippingMethodsBlockClasses().map(function(t){return"."+t+" "+e.getShippintMethodsRadioControlSelector()}).join(", ")},getShippintMethodsBlockSelector:function(){return this.getShippingMethodsBlockClasses().map(function(e){return"."+e}).join(", ")},getShippintMethodTextLabelSelector:function(){return".wc-block-components-radio-control__label"},getShippingMethodsBlockClasses:function(){return["wp-block-woocommerce-checkout-shipping-methods-block","wp-block-woocommerce-cart-order-summary-shipping-block"]},getShippintMethodsRadioControlSelector:function(){return".wc-block-components-radio-control input"},showError:function(e){console.error(e)},onCartChange:function(t){var o=this;jQuery(o.getShippintMethodsBlockSelector()).filter(function(e,t){return o.isBlockReady(t)}).length>0&&t(),e.util.observeDom(document.body,function(e){var t=!1;if(e.addedNodes)for(var n=0;n<e.addedNodes.length;n++){var a=e.addedNodes[n];if(o.isBlockReady(a)){t=!0;break}}if(e.removedNodes&&!t)for(var i=0;i<e.removedNodes.length;i++){var r=e.removedNodes[i];if(o.isLoaderBlock(r)){t=!0;break}}return t},t)},isBlockReady:function(e){return this.getShippingMethodsBlockClasses().filter(function(t){return e.classList&&e.classList.contains(t)}).length>0&&jQuery(e).find(this.getShippintMethodsRadioControlSelector()).has(":checked")},isLoaderBlock:function(e){return e.classList&&e.classList.contains("wc-block-components-spinner")},updateShippingMethodExtraLabelCache:function(e,t,o){e in this.cache||(this.cache[e]={}),this.cache[e][t]=o},getShippingMethodCachedExtraLabel:function(e,t){return e in this.cache&&t in this.cache[e]?this.cache[e][t]:null},refreshShippingMethodExtraLabel:function(){var e=this.getSelectedShippingMethod(),t=this.getSelectedPackageKey(),o=this.getShippingMethodCachedExtraLabel(t,e);(jQuery(this.getShippintMethodsBlockSelector()).find("label "+this.getShippintMethodTextLabelSelector()).find(".laposteproexp-extra-label").remove(),null!==o)&&jQuery(this.getShippintMethodsBlockSelector()).find("label").has("input:checked").find(this.getShippintMethodTextLabelSelector()).first().append('<span class="laposteproexp-extra-label"><br/>'+o+"</span>")}},e.legacy={packageKey:null,init:function(){var t=this,o=t.getFrontendData();null!==o?(e.api.setApiConfiguration(o.ajaxurl,o.getShippingMethodExtraLabelNonce,o.getPointsNonce,o.setPointNonce),e.map.setMapConfiguration(o.mapUrl,o.mapLogoImageUrl,o.mapLogoHrefUrl),e.util.on("body","click",".laposteproexp-select-parcel",function(o){t.setPackageKey(o),e.map.init(),e.map.open(),t.getMapPoints()}),e.util.on("body","click",".laposteproexp-parcel-point-button",function(){var o=e.util.isI18nEnabled()?wp.i18n.__("Unable to find carrier","la-poste-pro-expeditions-woocommerce"):e.util.translate("Unable to find carrier"),n=t.getSelectedCarrier();n||t.showError(o),e.api.selectPoint(n,t.packageKey,this.getAttribute("data-code"),decodeURIComponent(this.getAttribute("data-name")),this.getAttribute("data-network"),decodeURIComponent(this.getAttribute("data-street")),decodeURIComponent(this.getAttribute("data-zipcode")),decodeURIComponent(this.getAttribute("data-city")),decodeURIComponent(this.getAttribute("data-country")),decodeURIComponent(this.getAttribute("data-openinghours")),decodeURIComponent(this.getAttribute("data-distance")),function(o){var n=o.name,a=o.address,i=o.zipcode,r=o.city,p=o.distance;t.initSelectedParcelPoint();var c=document.querySelector(".laposteproexp-parcel-address-"+t.packageKey),s=document.querySelector(".laposteproexp-parcel-name-"+t.packageKey);c&&(c.innerHTML=e.util.formatParcelPoingAddress(a,r,i,p)),s&&(s.innerHTML=n),e.map.close()},function(e){"object"===(void 0===e?"undefined":_typeof(e))&&"data"in e&&t.showError(e.data.message)})})):console.error("[la-poste-pro-expeditions-woocommerce] Failed to load plugin configuration (legacy)")},setPackageKey:function(e){this.packageKey=e.target.attributes.getNamedItem("data-package_key").value},getFrontendData:function(){var e=null;if("undefined"!=typeof laposteproexpData)e=laposteproexpData;else if("wc"in window&&"wcSettings"in window.wc){var t=window.wc.wcSettings.getSetting("la-poste-pro-expeditions-woocommerce-parcel-point_data");t&&(e=t)}return e},initSelectedParcelPoint:function(){var t=e.util.isI18nEnabled()?wp.i18n.__("Your parcel point:","la-poste-pro-expeditions-woocommerce"):e.util.translate("Your parcel point:"),o=document.querySelector(".laposteproexp-parcel-client-"+this.packageKey);o.innerHTML=t+" ";var n=document.createElement("span");n.setAttribute("class","laposteproexp-parcel-name-"+this.packageKey),o.appendChild(n)},getMapPoints:function(){var t=this,o=e.util.isI18nEnabled()?wp.i18n.__("Unable to find carrier","la-poste-pro-expeditions-woocommerce"):e.util.translate("Unable to find carrier"),n=t.getSelectedCarrier();n||t.showError(o),e.map.getPoints(n,t.packageKey,function(e){return t.showError(e)})},getSelectedCarrier:function(){var e=void 0,t=document.querySelector('input[type="hidden"].shipping_method');t?e=t.getAttribute("value"):e=document.querySelector("input.shipping_method:checked").getAttribute("value");return e},showError:function(t){e.map.close(),alert(t)}},document.addEventListener("DOMContentLoaded",function(){e.util.isWoocommerceBlocks()?e.blocks.init():e.legacy.init()})}();